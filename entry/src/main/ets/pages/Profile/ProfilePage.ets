import { Constants } from '../../common/constants/Constants';
import { UserInfo } from '../../models/UserModel';
import { preferences } from '@kit.ArkData';
import { common } from '@kit.AbilityKit';
import { router } from '@kit.ArkUI';

// èœå•é¡¹æ¥å£
interface MenuItem {
  icon: string;
  title: string;
  arrow: boolean;
}

@Component
export struct ProfilePage {
  @State userInfo: UserInfo | null = null;
  @State isLoggedIn: boolean = false;

  aboutToAppear(): void {
    this.loadUserInfo();
  }

  // åŠ è½½ç”¨æˆ·ä¿¡æ¯
  private async loadUserInfo(): Promise<void> {
    try {
      const context = getContext(this) as common.UIAbilityContext;
      const prefs = preferences.getPreferencesSync(context, { name: 'mall_app_prefs' });
      const userInfoStr = prefs.getSync(Constants.USER_INFO, '') as string;

      if (userInfoStr) {
        this.userInfo = JSON.parse(userInfoStr) as UserInfo;
        this.isLoggedIn = true;
      }
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', JSON.stringify(error));
    }
  }

  // é€€å‡ºç™»å½•
  private async logout(): Promise<void> {
    try {
      const context = getContext(this) as common.UIAbilityContext;
      const prefs = preferences.getPreferencesSync(context, { name: 'mall_app_prefs' });
      prefs.deleteSync(Constants.USER_TOKEN);
      prefs.deleteSync(Constants.USER_INFO);
      await prefs.flush();

      router.replaceUrl({ url: 'pages/LoginPage' });
    } catch (error) {
      console.error('é€€å‡ºç™»å½•å¤±è´¥:', JSON.stringify(error));
    }
  }

  // èœå•åˆ—è¡¨
  private menuList: MenuItem[] = [
    { icon: 'ğŸ“¦', title: 'æˆ‘çš„è®¢å•', arrow: true },
    { icon: 'ğŸ“', title: 'æ”¶è´§åœ°å€', arrow: true },
    { icon: 'â¤ï¸', title: 'æˆ‘çš„æ”¶è—', arrow: true },
    { icon: 'ğŸ«', title: 'ä¼˜æƒ åˆ¸', arrow: true },
    { icon: 'â­', title: 'æˆ‘çš„è¯„ä»·', arrow: true },
    { icon: 'ğŸ’¬', title: 'è”ç³»å®¢æœ', arrow: true },
    { icon: 'âš™ï¸', title: 'è®¾ç½®', arrow: true }
  ];

  // ç”¨æˆ·å¤´åƒåŒºåŸŸ
  @Builder
  UserHeader() {
    Row() {
      // å¤´åƒ
      if (this.userInfo?.avatar) {
        Image(this.userInfo.avatar)
          .width(70)
          .height(70)
          .borderRadius(35)
          .objectFit(ImageFit.Cover)
      } else {
        Text('ğŸ‘¤')
          .fontSize(40)
          .width(70)
          .height(70)
          .textAlign(TextAlign.Center)
          .backgroundColor('#F5F5F5')
          .borderRadius(35)
      }

      // ç”¨æˆ·ä¿¡æ¯
      Column() {
        Text(this.userInfo?.nickname || this.userInfo?.account || 'ç”¨æˆ·')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)

        if (this.userInfo?.mobile) {
          Text(this.userInfo.mobile)
            .fontSize(14)
            .fontColor('#FFFFFFCC')
            .margin({ top: 6 })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 16 })
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 40, bottom: 40 })
    .backgroundColor(Constants.PRIMARY_COLOR)
  }

  // è®¢å•ç»Ÿè®¡åŒºåŸŸ
  @Builder
  OrderStats() {
    Row() {
      Column() {
        Text('0')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(Constants.TEXT_PRIMARY)
        Text('å¾…ä»˜æ¬¾')
          .fontSize(12)
          .fontColor(Constants.TEXT_SECONDARY)
          .margin({ top: 4 })
      }
      .layoutWeight(1)

      Column() {
        Text('0')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(Constants.TEXT_PRIMARY)
        Text('å¾…å‘è´§')
          .fontSize(12)
          .fontColor(Constants.TEXT_SECONDARY)
          .margin({ top: 4 })
      }
      .layoutWeight(1)

      Column() {
        Text('0')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(Constants.TEXT_PRIMARY)
        Text('å¾…æ”¶è´§')
          .fontSize(12)
          .fontColor(Constants.TEXT_SECONDARY)
          .margin({ top: 4 })
      }
      .layoutWeight(1)

      Column() {
        Text('0')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(Constants.TEXT_PRIMARY)
        Text('å¾…è¯„ä»·')
          .fontSize(12)
          .fontColor(Constants.TEXT_SECONDARY)
          .margin({ top: 4 })
      }
      .layoutWeight(1)
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(Constants.BORDER_RADIUS)
    .margin({ left: Constants.PADDING_NORMAL, right: Constants.PADDING_NORMAL, top: -20 })
  }

  // èœå•åˆ—è¡¨
  @Builder
  MenuList() {
    Column() {
      ForEach(this.menuList, (item: MenuItem) => {
        Row() {
          Text(item.icon)
            .fontSize(20)
            .width(30)

          Text(item.title)
            .fontSize(15)
            .fontColor(Constants.TEXT_PRIMARY)
            .margin({ left: 12 })

          Blank()

          if (item.arrow) {
            Text('>')
              .fontSize(16)
              .fontColor(Constants.TEXT_HINT)
          }
        }
        .width('100%')
        .height(50)
        .padding({ left: 16, right: 16 })

        Divider()
          .color('#F0F0F0')
      })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius(Constants.BORDER_RADIUS)
    .margin({ left: Constants.PADDING_NORMAL, right: Constants.PADDING_NORMAL, top: 16 })
  }

  build() {
    Column() {
      Scroll() {
        Column() {
          this.UserHeader()
          this.OrderStats()
          this.MenuList()

          Button('é€€å‡ºç™»å½•')
            .width('90%')
            .height(44)
            .fontSize(16)
            .fontColor(Constants.PRIMARY_COLOR)
            .backgroundColor(Color.White)
            .borderRadius(22)
            .borderWidth(1)
            .borderColor(Constants.PRIMARY_COLOR)
            .margin({ top: 30, bottom: 30 })
            .onClick(() => {
              this.logout();
            })
        }
        .width('100%')
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Constants.BACKGROUND_COLOR)
  }
}
