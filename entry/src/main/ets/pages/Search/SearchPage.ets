import { Constants } from '../../common/constants/Constants';
import httpUtil from '../../common/utils/HttpUtil';
import { GoodsItem } from '../../models/HomeModel';
import { router } from '@kit.ArkUI';
import { common } from '@kit.AbilityKit';
import speechRecognizerUtil, { SpeechRecognitionCallback } from '../../common/utils/SpeechRecognizerUtil';
import imageRecognitionUtil, { ImageRecognitionCallback } from '../../common/utils/ImageRecognitionUtil';
import { promptAction } from '@kit.ArkUI';

@Entry
@Component
struct SearchPage {
  @State searchKeyword: string = '';
  @State searchResults: GoodsItem[] = [];
  @State isSearching: boolean = false;
  @State hasSearched: boolean = false;
  @State searchHistory: string[] = [];

  // è¯­éŸ³è¯†åˆ«ç›¸å…³çŠ¶æ€
  @State isRecording: boolean = false;
  // å›¾åƒè¯†åˆ«ç›¸å…³çŠ¶æ€
  @State isImageRecognizing: boolean = false;
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext;

  aboutToAppear(): void {
    // å¯ä»¥ä»æœ¬åœ°å­˜å‚¨åŠ è½½æœç´¢å†å²
  }

  // æ‰§è¡Œæœç´¢
  private async doSearch(): Promise<void> {
    if (!this.searchKeyword.trim()) {
      return;
    }

    this.isSearching = true;
    this.hasSearched = true;

    // æ·»åŠ åˆ°æœç´¢å†å²
    if (!this.searchHistory.includes(this.searchKeyword)) {
      this.searchHistory = [this.searchKeyword, ...this.searchHistory.slice(0, 9)];
    }

    try {
      // æœç´¢å•†å“API
      const response = await httpUtil.get<GoodsItem[]>(
        `${Constants.API_BASE_URL}/home/goods?keyword=${encodeURIComponent(this.searchKeyword)}`
      );
      if (response.code === '1' && response.result) {
        this.searchResults = response.result;
      } else {
        this.searchResults = [];
      }
    } catch (error) {
      console.error('æœç´¢å¤±è´¥:', JSON.stringify(error));
      this.searchResults = [];
    } finally {
      this.isSearching = false;
    }
  }

  // æ¸…ç©ºæœç´¢å†å²
  private clearHistory(): void {
    this.searchHistory = [];
  }

  // è¿”å›ä¸Šä¸€é¡µ
  private goBack(): void {
    router.back();
  }

  // åˆ‡æ¢è¯­éŸ³è¯†åˆ«
  private async toggleVoiceRecognition(): Promise<void> {
    if (this.isRecording) {
      // åœæ­¢å½•éŸ³
      speechRecognizerUtil.stopListening();
      this.isRecording = false;
    } else {
      // å¼€å§‹å½•éŸ³
      const callback: SpeechRecognitionCallback = {
        onResult: (text: string) => {
          this.searchKeyword = text;
          promptAction.showToast({ message: `è¯†åˆ«ç»“æœ: ${text}` });
          // è‡ªåŠ¨æ‰§è¡Œæœç´¢
          this.doSearch();
        },
        onError: (error: string) => {
          promptAction.showToast({ message: error });
        },
        onStart: () => {
          this.isRecording = true;
          promptAction.showToast({ message: 'è¯·å¼€å§‹è¯´è¯...' });
        },
        onEnd: () => {
          this.isRecording = false;
        }
      };

      const success = await speechRecognizerUtil.startListening(this.context, callback);
      if (!success) {
        this.isRecording = false;
      }
    }
  }

  // æ˜¾ç¤ºå›¾ç‰‡é€‰æ‹©å¯¹è¯æ¡†
  private showImagePickerDialog(): void {
    promptAction.showActionMenu({
      title: 'é€‰æ‹©å›¾ç‰‡æ¥æº',
      buttons: [
        { text: 'æ‹ç…§', color: Constants.PRIMARY_COLOR },
        { text: 'ä»ç›¸å†Œé€‰æ‹©', color: Constants.TEXT_PRIMARY }
      ]
    }).then(async (result) => {
      if (result.index === 0) {
        // æ‹ç…§
        await this.pickAndRecognize('camera');
      } else if (result.index === 1) {
        // ç›¸å†Œ
        await this.pickAndRecognize('gallery');
      }
    }).catch((error: Error) => {
      console.info('ç”¨æˆ·å–æ¶ˆé€‰æ‹©');
    });
  }

  // é€‰æ‹©å›¾ç‰‡å¹¶è¯†åˆ«
  private async pickAndRecognize(source: 'camera' | 'gallery'): Promise<void> {
    this.isImageRecognizing = true;
    promptAction.showToast({ message: 'æ­£åœ¨è·å–å›¾ç‰‡...' });

    try {
      let imageUri: string | null = null;

      if (source === 'camera') {
        imageUri = await imageRecognitionUtil.pickFromCamera(this.context);
      } else {
        imageUri = await imageRecognitionUtil.pickFromGallery(this.context);
      }

      if (!imageUri) {
        this.isImageRecognizing = false;
        return;
      }

      promptAction.showToast({ message: 'æ­£åœ¨è¯†åˆ«å›¾ç‰‡æ–‡å­—...' });

      // è¯†åˆ«å›¾ç‰‡æ–‡å­—
      const callback: ImageRecognitionCallback = {
        onResult: (text: string) => {
          this.searchKeyword = text;
          this.isImageRecognizing = false;
          promptAction.showToast({ message: `è¯†åˆ«ç»“æœ: ${text}` });
          // è‡ªåŠ¨æ‰§è¡Œæœç´¢
          this.doSearch();
        },
        onError: (error: string) => {
          this.isImageRecognizing = false;
          promptAction.showToast({ message: error });
        }
      };

      await imageRecognitionUtil.recognizeText(imageUri, callback);
    } catch (error) {
      this.isImageRecognizing = false;
      promptAction.showToast({ message: 'å›¾ç‰‡è¯†åˆ«å¤±è´¥' });
    }
  }

  // æœç´¢æ 
  @Builder
  SearchHeader() {
    Row() {
      // è¿”å›æŒ‰é’®
      Text('â†')
        .fontSize(24)
        .fontColor(Constants.TEXT_PRIMARY)
        .width(40)
        .height(40)
        .textAlign(TextAlign.Center)
        .onClick(() => {
          this.goBack();
        })

      // æœç´¢è¾“å…¥æ¡†
      Row() {
        Text('ğŸ”')
          .fontSize(16)
          .margin({ left: 12 })

        TextInput({ placeholder: 'æœç´¢å•†å“', text: this.searchKeyword })
          .layoutWeight(1)
          .height(36)
          .backgroundColor(Color.Transparent)
          .onChange((value: string) => {
            this.searchKeyword = value;
          })
          .onSubmit(() => {
            this.doSearch();
          })
      }
      .layoutWeight(1)
      .height(40)
      .backgroundColor('#F5F5F5')
      .borderRadius(20)

      // è¯­éŸ³æŒ‰é’®
      Row() {
        Image($r('sys.media.ohos_ic_public_voice'))
          .width(20)
          .height(20)
          .fillColor(this.isRecording ? '#FF4444' : Constants.TEXT_SECONDARY)
      }
      .width(36)
      .height(36)
      .justifyContent(FlexAlign.Center)
      .margin({ left: 8 })
      .backgroundColor(this.isRecording ? '#FFEBEE' : '#F5F5F5')
      .borderRadius(18)
      .onClick(() => {
        this.toggleVoiceRecognition();
      })

      // æ‹ç…§è¯†å›¾æŒ‰é’®
      Row() {
        if (this.isImageRecognizing) {
          LoadingProgress()
            .width(20)
            .height(20)
            .color(Constants.PRIMARY_COLOR)
        } else {
          Image($r('sys.media.ohos_ic_public_scan'))
            .width(20)
            .height(20)
            .fillColor(Constants.TEXT_SECONDARY)
        }
      }
      .width(36)
      .height(36)
      .justifyContent(FlexAlign.Center)
      .margin({ left: 4 })
      .backgroundColor('#F5F5F5')
      .borderRadius(18)
      .onClick(() => {
        if (!this.isImageRecognizing) {
          this.showImagePickerDialog();
        }
      })

      // æœç´¢æŒ‰é’®
      Text('æœç´¢')
        .fontSize(14)
        .fontColor(Constants.PRIMARY_COLOR)
        .margin({ left: 8 })
        .onClick(() => {
          this.doSearch();
        })
    }
    .width('100%')
    .height(56)
    .padding({ left: 12, right: 16 })
    .backgroundColor(Color.White)
  }

  // æœç´¢å†å²
  @Builder
  SearchHistory() {
    Column() {
      Row() {
        Text('æœç´¢å†å²')
          .fontSize(14)
          .fontColor(Constants.TEXT_PRIMARY)
          .fontWeight(FontWeight.Bold)

        Blank()

        Text('æ¸…ç©º')
          .fontSize(12)
          .fontColor(Constants.TEXT_HINT)
          .onClick(() => {
            this.clearHistory();
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16, bottom: 12 })

      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(this.searchHistory, (keyword: string) => {
          Text(keyword)
            .fontSize(13)
            .fontColor(Constants.TEXT_SECONDARY)
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .backgroundColor('#F5F5F5')
            .borderRadius(14)
            .margin({ right: 8, bottom: 8 })
            .onClick(() => {
              this.searchKeyword = keyword;
              this.doSearch();
            })
        })
      }
      .width('100%')
      .padding({ left: 16, right: 16 })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .margin({ top: 12 })
    .borderRadius(Constants.BORDER_RADIUS)
  }

  // çƒ­é—¨æœç´¢
  @Builder
  HotSearch() {
    Column() {
      Text('çƒ­é—¨æœç´¢')
        .fontSize(14)
        .fontColor(Constants.TEXT_PRIMARY)
        .fontWeight(FontWeight.Bold)
        .width('100%')
        .padding({ left: 16, top: 16, bottom: 12 })

      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(['æ‰‹æœº', 'ç”µè„‘', 'è€³æœº', 'å¹³æ¿', 'æ™ºèƒ½æ‰‹è¡¨', 'é”®ç›˜', 'é¼ æ ‡', 'æ˜¾ç¤ºå™¨'], (keyword: string) => {
          Text(keyword)
            .fontSize(13)
            .fontColor(Constants.TEXT_SECONDARY)
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .backgroundColor('#F5F5F5')
            .borderRadius(14)
            .margin({ right: 8, bottom: 8 })
            .onClick(() => {
              this.searchKeyword = keyword;
              this.doSearch();
            })
        })
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 16 })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .margin({ top: 12 })
    .borderRadius(Constants.BORDER_RADIUS)
  }

  // æœç´¢ç»“æœ
  @Builder
  SearchResults() {
    if (this.searchResults.length === 0) {
      // æ— ç»“æœ
      Column() {
        Text('ğŸ˜”')
          .fontSize(48)
          .margin({ top: 60 })

        Text('æœªæ‰¾åˆ°ç›¸å…³å•†å“')
          .fontSize(14)
          .fontColor(Constants.TEXT_HINT)
          .margin({ top: 16 })

        Text('æ¢ä¸ªå…³é”®è¯è¯•è¯•å§~')
          .fontSize(12)
          .fontColor(Constants.TEXT_HINT)
          .margin({ top: 8 })
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
    } else {
      // ç»“æœåˆ—è¡¨
      List() {
        ForEach(this.searchResults, (item: GoodsItem) => {
          ListItem() {
            Row() {
              Image(item.picture)
                .width(100)
                .height(100)
                .borderRadius(8)
                .objectFit(ImageFit.Cover)

              Column() {
                Text(item.name)
                  .fontSize(14)
                  .fontColor(Constants.TEXT_PRIMARY)
                  .maxLines(2)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })

                Text(item.desc)
                  .fontSize(12)
                  .fontColor(Constants.TEXT_HINT)
                  .margin({ top: 6 })
                  .maxLines(1)

                Row() {
                  Text('Â¥')
                    .fontSize(12)
                    .fontColor(Constants.PRIMARY_COLOR)
                  Text(item.price)
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(Constants.PRIMARY_COLOR)
                }
                .margin({ top: 8 })
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Start)
              .margin({ left: 12 })
            }
            .width('100%')
            .padding(12)
            .backgroundColor(Color.White)
            .borderRadius(Constants.BORDER_RADIUS)
          }
          .margin({ bottom: 12 })
        }, (item: GoodsItem) => item.id)
      }
      .width('100%')
      .layoutWeight(1)
    }
  }

  build() {
    Column() {
      // æœç´¢æ 
      this.SearchHeader()

      if (!this.hasSearched) {
        // æœªæœç´¢æ—¶æ˜¾ç¤ºå†å²å’Œçƒ­é—¨
        Scroll() {
          Column() {
            if (this.searchHistory.length > 0) {
              this.SearchHistory()
            }
            this.HotSearch()
          }
          .width('100%')
        }
        .layoutWeight(1)
        .padding({ left: Constants.PADDING_NORMAL, right: Constants.PADDING_NORMAL })
      } else {
        // æœç´¢ç»“æœ
        Column() {
          if (this.isSearching) {
            LoadingProgress()
              .width(40)
              .height(40)
              .margin({ top: 60 })
          } else {
            this.SearchResults()
          }
        }
        .layoutWeight(1)
        .padding({ left: Constants.PADDING_NORMAL, right: Constants.PADDING_NORMAL, top: 12 })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Constants.BACKGROUND_COLOR)
  }
}
